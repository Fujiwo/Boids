"use strict";var Vector2D=function(){function Vector2D(x,y){void 0===x&&(x=0),void 0===y&&(y=0),this.x=x,this.y=y}return Object.defineProperty(Vector2D.prototype,"absoluteValue",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),Vector2D.prototype.clone=function(){return new Vector2D(this.x,this.y)},Vector2D.prototype.plus=function(another){return new Vector2D(this.x+another.x,this.y+another.y)},Vector2D.prototype.plusEqual=function(another){this.x+=another.x,this.y+=another.y},Vector2D.prototype.minus=function(another){return new Vector2D(this.x-another.x,this.y-another.y)},Vector2D.prototype.minusEqual=function(another){this.x-=another.x,this.y-=another.y},Vector2D.prototype.multiply=function(value){return new Vector2D(this.x*value,this.y*value)},Vector2D.prototype.innerProduct=function(another){return new Vector2D(this.x*another.x,this.y*another.y)},Vector2D.prototype.divideBy=function(value){return new Vector2D(this.x/value,this.y/value)},Vector2D.prototype.divideByEqual=function(value){this.x/=value,this.y/=value},Vector2D.prototype.getDistance=function(another){return this.minus(another).absoluteValue},Vector2D}(),Boid=function(){function Boid(position,velocity,color){void 0===position&&(position=new Vector2D),void 0===velocity&&(velocity=new Vector2D),void 0===color&&(color="black"),this.position=position,this.velocity=velocity,this.color=color}return Object.defineProperty(Boid.prototype,"speed",{get:function(){return this.velocity.absoluteValue},enumerable:!0,configurable:!0}),Boid.prototype.draw=function(context){this.drawShape(context,this.position,Boid.size,this.color)},Boid.prototype.move=function(){this.velocity.plusEqual(Boid.getRandomVector()),this.position.plusEqual(this.velocity)},Boid.prototype.getDistance=function(another){return this.position.getDistance(another.position)},Boid.prototype.drawShape=function(context,center,size,color){var halfVelocity=this.velocity.multiply(size/2),point1=this.position.plus(halfVelocity),middlePoint=this.position.minus(halfVelocity),velocityAbsoluteValue=this.velocity.absoluteValue,unitVelocity=this.velocity.multiply(size/(velocityAbsoluteValue*velocityAbsoluteValue)),point2=middlePoint.plus(new Vector2D(unitVelocity.y,-unitVelocity.x)),point3=middlePoint.plus(new Vector2D(-unitVelocity.y,unitVelocity.x));Boid.drawPolygon(context,[point1,point2,point3],color)},Boid.drawPolygon=function(context,polygon,color){var polygonLength=polygon.length;if(!(polygonLength<2)){context.fillStyle=color,context.beginPath(),context.moveTo(polygon[0].x,polygon[0].y);for(var index=1;index<polygonLength;index++)context.lineTo(polygon[index].x,polygon[index].y);context.fill()}},Boid.getRandomVector=function(){return new Vector2D(Boid.getRandomDistance(),Boid.getRandomDistance())},Boid.getRandomDistance=function(){return Boid.maximumRandomDistance*(Math.random()+Math.random())-Boid.maximumRandomDistance},Boid.defaultSize=4,Boid.defaultMaximumRandomDistance=2,Boid.size=Boid.defaultSize,Boid.maximumRandomDistance=Boid.defaultMaximumRandomDistance,Boid}(),Boids=function(){function Boids(){this.boids=[]}return Boids.prototype.append=function(boid){this.boids.push(boid)},Boids.prototype.move=function(size){for(var sum=this.getSum(),boidCount=this.boids.length,index=0;index<boidCount;index++){var boid=this.boids[index],speed=boid.speed;this.cohesion(sum.position,boid),this.separation(index),this.alignment(sum.velocity,boid),speed>=Boids.maximumSpeed&&(boid.velocity=boid.velocity.multiply(Boids.maximumSpeed/speed)),(boid.position.x<0&&boid.velocity.x<0||boid.position.x>size.x&&boid.velocity.x>0)&&(boid.velocity.x*=-1),(boid.position.y<0&&boid.velocity.y<0||boid.position.y>size.y&&boid.velocity.y>0)&&(boid.velocity.y*=-1),boid.move()}},Boids.prototype.getSum=function(){for(var sum=new Boid,boidCount=this.boids.length,index=0;index<boidCount;index++)sum.position.plusEqual(this.boids[index].position),sum.velocity.plusEqual(this.boids[index].velocity);return sum},Boids.prototype.cohesion=function(sum,boid){var center=sum.clone();center.minusEqual(boid.position),center.divideByEqual(this.boids.length-1),boid.velocity.plusEqual(center.minus(boid.position).divideBy(Boids.cohesionParameter))},Boids.prototype.separation=function(index){for(var i=0,length_1=this.boids.length;i<length_1;i++)i!==index&&this.boids[i].getDistance(this.boids[index])<Boids.separationParameter&&this.boids[index].velocity.minusEqual(this.boids[i].position.minus(this.boids[index].position))},Boids.prototype.alignment=function(sum,boid){var average=sum.clone();average.minusEqual(boid.velocity),average.divideByEqual(this.boids.length-1),boid.velocity.plusEqual(average.minus(boid.velocity).divideBy(Boids.alignmentParameter))},Boids.defaultInitialBoidCount=250,Boids.defaultMaximumSpeed=8,Boids.defaultCohesionParameter=100,Boids.defaultSeparationParameter=10,Boids.defaultAlignmentParameter=7,Boids.initialBoidCount=Boids.defaultInitialBoidCount,Boids.maximumSpeed=Boids.defaultMaximumSpeed,Boids.cohesionParameter=Boids.defaultCohesionParameter,Boids.separationParameter=Boids.defaultSeparationParameter,Boids.alignmentParameter=Boids.defaultAlignmentParameter,Boids}(),View=function(){function View(){this.size=new Vector2D,this.canvas=document.querySelector("#canvas"),this.context=this.canvas.getContext("2d")}return View.prototype.update=function(){var panel=document.getElementById("panel");this.size.x=this.canvas.width=Math.round(window.innerWidth*View.sizeRate),this.size.y=this.canvas.height=Math.round((window.innerHeight-(null==panel?0:panel.clientHeight))*View.sizeRate)},View.prototype.drawBoids=function(boids){this.drawAllBoid(boids.boids)},View.prototype.drawAllBoid=function(boids){this.context.clearRect(0,0,this.size.x,this.size.y);for(var index=0,length_2=boids.length;index<length_2;index++)boids[index].draw(this.context);this.drawCount(boids.length)},View.prototype.drawCount=function(count){this.context.fillStyle="gray",this.context.font="14px",this.context.fillText("Boids: "+String(count),20,20)},View.sizeRate=.95,View}(),Settings=function(){function Settings(){}return Settings.get=function(){return{boidSize:Boid.size,randomParameter:Boid.maximumRandomDistance,initialBoidCount:Boids.initialBoidCount,maximumSpeed:Boids.maximumSpeed,cohesionParameter:Boids.cohesionParameter,separationParameter:Boids.separationParameter,alignmentParameter:Boids.alignmentParameter}},Settings.set=function(boidSize,randomParameter,initialBoidCount,maximumSpeed,cohesionParameter,separationParameter,alignmentParameter){Boid.size=boidSize,Boid.maximumRandomDistance=randomParameter,Boids.initialBoidCount=initialBoidCount,Boids.maximumSpeed=maximumSpeed,Boids.cohesionParameter=cohesionParameter,Boids.separationParameter=separationParameter,Boids.alignmentParameter=alignmentParameter},Settings.reset=function(){Boid.size=Boid.defaultSize,Boid.maximumRandomDistance=Boid.defaultMaximumRandomDistance,Boids.initialBoidCount=Boids.defaultInitialBoidCount,Boids.maximumSpeed=Boids.defaultMaximumSpeed,Boids.cohesionParameter=Boids.defaultCohesionParameter,Boids.separationParameter=Boids.defaultSeparationParameter,Boids.alignmentParameter=Boids.defaultAlignmentParameter},Settings.save=function(){return!!window.localStorage&&(window.localStorage.setItem(Settings.key,JSON.stringify(Settings.get())),!0)},Settings.load=function(){if(!window.localStorage)return!1;var jsonText=window.localStorage.getItem(Settings.key);if(null==jsonText)return!1;var data=JSON.parse(jsonText);return null!=data&&(Settings.set(data.boidSize,data.randomParameter,data.initialBoidCount,data.maximumSpeed,data.cohesionParameter,data.separationParameter,data.alignmentParameter),!0)},Settings.key="ShoBoids",Settings}(),Program=function(){function Program(){var _this=this;this.boids=new Boids,this.view=new View,this.appendTimer=0,Settings.load(),setTimeout((function(){return _this.initialize()}),Program.startTime)}return Program.prototype.initialize=function(){var _this=this;this.bindEvents(),this.view.update(),this.appendBoids(Boids.initialBoidCount),setInterval((function(){return _this.step()}),1e3/Program.fps),Program.initializeForm()},Program.prototype.bindEvents=function(){var _this=this;this.view.canvas.addEventListener("mousedown",(function(e){return _this.appendBoids(1,Program.getMousePosition(_this.view.canvas,e))})),this.view.canvas.addEventListener("touchstart",(function(e){return _this.appendBoids(1,Program.getTouchPosition(_this.view.canvas,e))})),this.view.canvas.addEventListener("mouseup",(function(){return clearInterval(_this.appendTimer)})),this.view.canvas.addEventListener("touchend",(function(){return clearInterval(_this.appendTimer)})),window.addEventListener("resize",(function(){return _this.view.update()}))},Program.getMousePosition=function(element,e){var rect=element.getBoundingClientRect();return new Vector2D(e.clientX-rect.left,e.clientY-rect.top)},Program.getTouchPosition=function(element,e){var rect=element.getBoundingClientRect(),touch=e.changedTouches[0];return new Vector2D(touch.clientX-rect.left,touch.clientY-rect.top)},Program.prototype.appendBoids=function(count,position){var _this=this,index=0;this.appendTimer=setInterval((function(){count>0&&index>=count?clearInterval(_this.appendTimer):(_this.boids.append(Program.createBoid(_this.view.size,position)),index++)}),Program.createTime)},Program.createBoid=function(areaSize,position){return new Boid(position||areaSize.innerProduct(new Vector2D(Math.random(),Math.random())),new Vector2D,this.getRandomColor())},Program.getRandomColor=function(){return"rgba("+String(Program.getRandomColorValue())+", "+String(Program.getRandomColorValue())+", "+String(Program.getRandomColorValue())+", "+String(Program.getOpactiy())+")"},Program.getRandomColorValue=function(){return Math.round(Math.random()*Program.colorValueBase)},Program.getOpactiy=function(){return Math.round(Math.random()*(Program.opacityBase2-Program.opacityBase1)+Program.opacityBase1)},Program.prototype.step=function(){this.view.drawBoids(this.boids),this.boids.move(this.view.size)},Program.onFormSubmit=function(){var settingForm=document.settingForm;Settings.set(Number(settingForm.boidSizeTextBox.value),Number(settingForm.randomParameterTextBox.value),Number(settingForm.initialBoidCountTextBox.value),Number(settingForm.maximumSpeedTextBox.value),Number(settingForm.cohesionParameterTextBox.value),Number(settingForm.separationParameterTextBox.value),Number(settingForm.alignmentParameterTextBox.value)),Settings.save()},Program.onReset=function(){Settings.reset(),Settings.save(),Program.initializeForm()},Program.initializeForm=function(){var settings=Settings.get();Program.setToInput("boidSizeTextBox",settings.boidSize),Program.setToInput("randomParameterTextBox",settings.randomParameter),Program.setToInput("initialBoidCountTextBox",settings.initialBoidCount),Program.setToInput("maximumSpeedTextBox",settings.maximumSpeed),Program.setToInput("cohesionParameterTextBox",settings.cohesionParameter),Program.setToInput("separationParameterTextBox",settings.separationParameter),Program.setToInput("alignmentParameterTextBox",settings.alignmentParameter)},Program.setToInput=function(inputName,value){var elements=document.getElementsByName(inputName);elements.length>0&&(elements[0].value=String(value))},Program.fps=30,Program.createTime=10,Program.startTime=100,Program.colorValueBase=160,Program.opacityBase1=.4,Program.opacityBase2=.6,Program}();onload=function(){return new Program};